


# Api
[Jump to API index.](#index)
## A (rich) promise in return...
Every api method returns a [Bluebird][1] promise, decorated with the following properties:

- **query** The cypher query to serve to the Neo4j HTTP server
- **originalQuery** The cypher query generated by the neo4acl lib. Here the query identifiers are not replaced with those you may provide in the library configuration object
- **parameters** An object containing the parameters to serve with the cypher query
- **parser** A function which takes a callback as parameter. Returns a function that, if called with the **db query results**, will call the callback with the **api results**. (Useful for multi queries transactions)
- **execute** A function which triggers the query to the database and returns the promise itself

The returned promise is *inactivated* by default, meanig that the following call:

```javacript
var richpromise = acl.getUserGroups('giacomo');
```
will not trigger any query to the database. 

Being a promise, you can let `richpromise` *fly away* somewhere in your code.
It will never be resolved or rejected untill you call
```javascript
richpromise.execute()
```

This will trigger the query to the db, process the query results, and resolve the promise with the **api result** or reject it with an error from the db (if any).

The promise can be *executed* just once. Any subsequent call to `richpromise.execute()` will not query the db anymore and just return the promise itself.

If you want that the api method immediately fires a query when you call it, just pass a callback as last parameter.
So

```javascript
var richpromise = acl.getUserGroups('giacomo', function(err, groups) {});
```
will immediately query the database.
The passed callback receives an eventual error from the db and the **api result**.

**NOTE: in the example above 'groups' is not the direct result of the database query, but the value returned by the database result processing (also called 'api result').**

In this scenario `richpromise` is still a promise which will be resolved or rejected.
```javascript
richpromise.then(function(groups) {
    // groups === groups variable passed to the callback in the above call
});
```
## ... is useful for transaction purposes.
I hear you...

"...what if I could make acl queries as part of a wider transaction..."

**Here you are!**

The `query` and `parameters` property of every promise resulting from an api call, are tought to be exploited in a multi query transaction scenario.

In the following example you can also see how to use the `parser` function.

```javascript
var seraph = require('seraph');
var neo4j = seraph();

var acl = require('neo4acl')();

var create_giacomo_user = 'MERGE (user:User {_id:\'giacomo\'}) RETURN user';
var put_user_in_groups = acl.addUserToGroups('giacomo', ['user_giacomo', 'males']);
var get_user_groups = acl.getUserGroups('giacomo');

var txn = neo4j.batch();

    txn.query(create_giacomo_user);
    txn.query(put_user_in_groups.query, put_user_in_groups.parameters);
    txn.query(get_user_groups.query, get_user_groups.parameters, get_user_groups.parser(function(err, groups) {
        // 'groups' is an api result
    }));
    
    txn.commit(); // All queries are committed as a single transaction. <3

```
***
[Jump to top.](#api) -  [Jump to API index.](#index) 
***
## (not so) Quick API example

```javascript
var util = require('util');
var Neo4acl = require('neo4acl');

var acl = Neo4acl();

// Let's say we already have two users in the graph
// {_id:'giacomo'} and {_id:'bob'}
// and no groups nor resources

var giacomo_groups; // <- We'll use this variable later...

acl
  .addUserToGroups('giacomo', ['admins', 'italian_users']).execute()
  .then(acl.addUserToGroups('bob', ['english_users']).execute)
  .then(acl.addGroupParents('admins', 'users').execute)
  .then(acl.addGroupParents('italian_users', ['users']).execute)
  .then(acl.addGroupParents('english_users', 'users').execute)
  .then(acl.giveResourcesPermissions('italian_users', 'italian_content', ['view']).execute)
  .then(acl.giveResourcesPermissions('english_users', 'english_content', ['view']).execute)
  .then(acl.giveResourcesPermissions('users', 'common_content', ['view']).execute)
  .then(acl.giveResourcesPermissions('admins', [
                                                'common_content',
                                                'italian_content',
                                                'english_content'
                                                ],
                                                ['view', 'post', 'put', 'delete', 'special_permission']
                                    ).execute)

  .then(acl.isUserInAllGroups('giacomo', ['admins', 'italian_users']).execute)
  .then(function(giacomo_is) {
    console.log('\nGiacomo is member of admins AND italian_users: ' + giacomo_is); // -> true

    return acl.isUserInAllGroups('bob', ['english_users', 'admins']).execute();
  })      
  .then(function(bob_is) {
    console.log('\nBob is member of english_users AND admins: ' + bob_is); // -> false

    return acl.isUserInAnyGroup('bob', ['english_users', 'admins']).execute();
  })
  .then(function(bob_is) {
    console.log('\nBob is member of english_users OR admins: ' + bob_is); // -> true

    return acl.hasUserAllPermissionsOnResources('bob', 'english_content', 'view', function(err, has_bob) {
      console.log('\nBob can \'view\' english_content: ' + has_bob); // -> true
    });
  })
  .then(function() {
    var acl_query = acl.hasUserAllPermissionsOnResources('giacomo', ['italian_content', 'english_content', 'common_content'], ['view', 'post', 'special_permission']);

    console.log('\nLet\'s wait 5 seconds....');
    setTimeout(function() {
      acl_query.execute();
    }, 5000);

    acl_query.then(function(has_giacomo) {
      console.log(
                  ['\nGiacomo has permissions \'view\', \'post\' and \'special_permission\'',
                   'on resources \'italian_content\', \'english_content\' and \'common_content\': ' + has_giacomo
                  ].join('\n')
                 ); // ->true
    });

    return acl_query;
  })   
  .then(function() {
    return acl.denyResourcesPermission('english_users', 'english_content', 'view', function(err, done) {
      console.log('\nNow english users CAN NOT \'view\' english_content.');
    });
  })
  .then(function() {
    return acl.hasUserAllPermissionsOnResources('bob', 'english_content', 'view', function(err, bool) {
      console.log('\nBob can \'view\' english_content: ' +bool); // -> false
    });
  })
  .then(function() {
    return acl.hasUserAllPermissionsOnResources('bob', 'common_content', 'view', function(err, bool) {
      console.log('\nBob can \'view\' common_content: ' +bool);// -> true
    });
  })
  .then(function() {
    return acl.getUserGroups('bob', function(err, groups) {
      console.log('\nBob is in the following groups:');
      console.log(util.inspect(groups, {depth: null}));
    });
  })
  .then(function() {
    return acl.getUserGroups('giacomo', function(err, groups) {
      // Let's use the 'giacomo_groups' variable to reference groups out of this scope
      giacomo_groups = groups;
      console.log('\nGiacomo is in the following groups:');
      console.log(util.inspect(groups, {depth: null}));
    });
  })
  .then(function(g_groups) {
    if (giacomo_groups === g_groups) {
      console.log('\n In Neo4acl the same objects are used both to resolve promises and to feed callbacks.');
    }
  });
  
```
***
[Jump to top.](#api)
***
## Index


[acl.addUserToGroups()](#acladdusertogroups-user_id-groups-cberr-done-)

[acl.removeUserFromGroups()](#aclremoveuserfromgroups-user_id-groups-cberr-done-)

[acl.getUserGroups()](#aclgetusergroups-user_id-cberr-groups-)

[acl.isUserInAllGroups()](#isUserInAllGroups)

[acl.isUserInAnyGroup()](#isUserInAnyGroup)

[acl.addGroupParents()](#addGroupParents)

[acl.removeGroup()](#removeGroup)

[acl.removeResource()](#removeResource)

[acl.giveResourcesPermissions()](#giveResourcesPermissions)

[acl.denyResourcesPermission()](#denyResourcesPermission)

[acl.getResourcesPermissions()](#getResourcesPermissions)

[acl.isAllowed()](#isAllowed)

[acl.isAllowedAny()](#isAllowedAny)

[acl.areAnyGroupsAllowed()](#areAnyGroupsAllowed)

----------

### acl.addUserToGroups( user_id, groups, cb(err, done) )
Parameters:

- **user_id** {String || Number} User id
- **groups** {String || [String, ...]} Group(s)
- **cb** {Function} [optional]
	- **err** {Object} A Neo4j REST API Layer error
	- **done** {Boolean}

Ad the user to the listed groups.
***
[Jump to top.](#api) -  [Jump to API index.](#index) 
***
### acl.removeUserFromGroups( user_id, groups, cb(err, done) )
Parameters:

- **user_id** {String || Number} User id
- **groups** {String || [String, ...]} Group(s)
- **cb** {Function} [optional]
	- **err** {Object} A Neo4j REST API Layer error
	- **done** {Boolean}

Removes the user from the listed groups.
***
[Jump to top.](#api) -  [Jump to API index.](#index) 
***
### acl.getUserGroups( user_id, cb(err, groups) )
Parameters:

- **user_id** {String || Number} User id
- **cb** {Function} [Optional]
    - **err** {Object} A Neo4j REST API Layer error
    - **groups** {Array} The list of groups the user belongs to
```javascript
        groups = [
                    {
                        name: 'Role name',
                        distance: 1,
                        since: timestamp()
                    },
                    {...}
                ] 
```
Returns an array of the groups the user belongs to.

For each group, the ```distance``` property tells if the user is a direct member of the group (if ```distance === 1```) or if she's N groups away.
The `since` indicates the date the user became member of the group, expressed in milliseconds since midnight, January 1, 1970 UTC.

**Note on how `since` is calculated:**

The library will first search for all the paths that connect the user to a group she's member of.

For every path, all the `BELOGNS_TO` relationships are reduced to find the one that was most recently created. This relationship's creation date is assumed as the "path creation date".

Then, for every group that the user belongs to, all the paths leading to it are compared to find the oldest one, and its creation date is assumed as the date since when the user belongs to the group.

In other words there is no **real** tracking of user memberships in time.

**"Simply put": given a certain state of the graph, you can only know the date from which a user is a member of a certain group for sure, but you can not know if she's already been a member of that group prior to that date.**



***
[Jump to top.](#api) -  [Jump to API index.](#index) 
***
### <a id="isUserInAllGroups"></a>acl.isUserInAllGroups( user_id, groups, cb(err, bool) )
Parameters:

- **user_id** {String || Number} User id 
- **groups** {String || [String, ...]} Group(s)
- **cb** {Function} [Optional]
    - **err** {Object} A Neo4j REST API Layer error
    - **bool** {Boolean}

Checks if the user belongs to each of the listed groups
***
[Jump to top.](#api) -  [Jump to API index.](#index) 
***
### <a id="isUserInAnyGroup"></a>acl.isUserInAnyGroup( user_id, groups, cb(err, bool) )
Parameters:

- **user_id** {String || Number} User id 
- **groups** {String || [String, ...]} Group(s)
- **cb** {Function} [Optional]
    - **err** {Object} A Neo4j REST API Layer error
    - **bool** {Boolean}

Checks if the user belongs to any of the listed groups
***
[Jump to top.](#api) -  [Jump to API index.](#index) 
***
### <a id="addGroupParents"></a>acl.addGroupParents( group, parents, cb(err, done) )
Parameters:

- **group** {String} Group
- **parents** {String || [String, ...]} Parent(s)
- **cb** {Function} [Optional]
    - **err** {Object} A Neo4j REST API Layer error
    - **done** {Boolean}

Set the given group as belonging to the listed parent groups.
***
[Jump to top.](#api) -  [Jump to API index.](#index) 
***
### <a id="removeGroup"></a>acl.removeGroup( group, cb(err, done) )
Parameters:

- **group** {String} Group
- **cb** {Function} [Optional]
    - **err** {Object} A Neo4j REST API Layer error
    - **done** {Boolean}

Removes the group and all it's permissions from the system.
***
[Jump to top.](#api) -  [Jump to API index.](#index) 
***
### <a id="removeResource"></a>acl.removeResource( resource_name, cb(err, done) )
Parameters:

- **resource_name** {String} Resource name
- **cb** {Function} [Optional]
    - **err** {Object} A Neo4j REST API Layer error
    - **done** {Boolean}

Removes the resource from the system.
***
[Jump to top.](#api) -  [Jump to API index.](#index) 
***
### <a id="giveResourcesPermissions"></a>acl.giveResourcesPermissions( groups, resources, permissions, cb(err, done) )
Parameters:

- **groups** {String || [String, ...]} Group(s)
- **resources** {String || [String, ...]} Resource(s)
- **permissions** {String || [String, ...] Permission(s)
- **cb** {Function} [Optional]
    - **err** {Object} A Neo4j REST API Layer error
    - **done** {Boolean}

Gives to the listed groups the listed permissions over the listed resources.
***
[Jump to top.](#api) -  [Jump to API index.](#index) 
***
### <a id="denyResourcesPermission"></a>acl.denyResourcesPermission( groups, resources, permissions, cb(err, done) )
Parameters:

- **groups** {String || [String, ...]} Group(s)
- **resources** {String || [String, ...]} Resource(s)
- **permissions** {String || [String, ...] Permission(s)
- **cb** {Function} [Optional]
    - **err** {Object} A Neo4j REST API Layer error
    - **done** {Boolean}

Removes the listed permissions over the listed resources from the listed groups.
***
[Jump to top.](#api) -  [Jump to API index.](#index) 
***
### <a id="getResourcesPermissions"></a>acl.getResourcesPermissions( user_id, resources, cb(err, resources) )
Parameters:

- **user_id** {String || Number} User id
- **resources** {String || [String, ...]} Resource(s)
- **cb** {Function} [Optional]
    - **err** {Object} A Neo4j REST API Layer error
    - **resources** {Array}
```javascript
        resources = [
                        {
                            name: 'Resource name',
                            permissions: [String, ...]
                        },
                        {...}
                    ]
```
Checks the permissions a user has over the listed resources.
Returns an array of resources.
***
[Jump to top.](#api) -  [Jump to API index.](#index) 
***
### <a id="isAllowed"></a>acl.isAllowed( user_id, resources, permissions, cb(err, allowed) )
Parameters:

- **user_id** {String || Number} User id
- **resources** {String || [String, ...]} Resource(s)
- **permissions** {String || [String, ...] Permission(s)
- **cb** {Function} [Optional]
    - **err** {Object} A Neo4j REST API Layer error
    - **allowed** {Boolean}

Checks if the user has ALL the listed permissions over all the listed resources.
***
[Jump to top.](#api) -  [Jump to API index.](#index) 
***
### <a id="isAllowedAny"></a>acl.isAllowedAny(user_id, resources, permissions, cb(err, allowed) )
Parameters:

- **user_id** {String || Number} User id
- **resources** {String || [String, ...]} Resource(s)
- **permissions** {String || [String, ...] Permission(s)
- **cb** {Function} [Optional]
    - **err** {Object} A Neo4j REST API Layer error
    - **allowed** {Boolean}

For each of the listed resources, checks if the user has ANY of the listed permission.
***
[Jump to top.](#api) -  [Jump to API index.](#index) 
***
### <a id="areAnyRolesAllowed"></a>acl.areAnyRolesAllowed( groups, resources, permissions, callback(err, allowed) )
Parameters:

- **groups** {String || [String, ...]} Group(s)
- **resources** {String || [String, ...]} Resource(s)
- **permissions** {String || [String, ...] Permission(s)
- **cb** {Function} [Optional]
    - **err** {Object} A Neo4j REST API Layer error
    - **allowed** {Boolean}

Checks if any of the listed groups has ALL the listed permissions over all the listed resources.


  [1]: https://github.com/petkaantonov/bluebird